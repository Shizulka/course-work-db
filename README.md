# Документація проєкту

## Назва проєкту та опис

Бібліотека , без додатку для патронів , все відбувається тут це у межах бібліотеки як будівлі.

Призначенна для ,логічно, структури бібліотеки.

Робили:Ліщук Чрина та Оситенко Мирослава ІМ-42.

## Технологічний стек

**Мова програмування:**
Python

**Framework:**

_FastAPI_ - маршрутизацію запитів та обробку HTTP-методів.

_Pytest_ - для тестів

**Бібліотеки:**

_Pydantic_- Для валідації та трансформації данних. Використовувалося у `schemas.py.`

**Сервер:**

_Uvicorn_ - необхідний для запуску FastAPI-додатку.

_Railway_ - використовується для хостингу та розгортання бази даних у мережі.

**Емейли:**

_email.mime та smtplib_ - для відправки сповіщень користувачам через емейл.

**База данниз:**

_PostgreSQL_ -для зберігання зв'язків між читачами та книгами.

_SQLAlchemy_ - для об'єктно-орієнтованої роботи з базою даних.

_psycopg2_ - для забезпечення технічного з'єднання між Python-кодом та сервером PostgreSQL.

**Інше:**

_Swagger UI_ - для візуалізації ендпоінтів API та тестувати їх прямо у браузері без написання фронтенду.

_Apscheduler_- для виконання фонових процесів за розкладом. Використовується в `scheduler.py`

_python-dotenv_- для .env файлу де ми зберігаємо доступ до пошти та бази данних.

## Інструкції з налаштування

#### Системні вимоги

1. Git (система контролю версій).
1. Мати Python 3.10 або новішої версії.
1. PostgreSQL 14 або новішої версії (локально або доступ до хмарної БД).
1. DBeaver або pgAdmin (рекомендовано для візуалізації бази даних).
1. ОС: Windows 10 x64 / Windows 11 x64 /Linux Mint 22.2
1. ПРОЦЕСОР: Intel Core i7-11700 / AMD Ryzen 7 5800X
1. ОПЕРАТИВНА ПАМ’ЯТЬ: 32 GB ОП
1. ВІДЕОКАРТА: Nvidia GeForce RTX 3070 Ti / Nvidia GeForce RTX 4070 / AMD Radeon RX 6800 XT
1. МІСЦЕ НА ДИСКУ: 160 GB доступного місця

#### Клонування репозиторію

Завантажте вихідний код проекту з віддаленого репозиторію GitHub:

```
git clone https://github.com/your-username/library-system.git
cd library-system
```

#### Встановлення залежностей

Встановіть необхідні бібліотеки, зазначені.

Сервер та Фреймворк:

```
pip install fastapi "uvicorn[standard]"
```

2. База даних (ORM та драйвер):

```
pip install sqlalchemy
psycopg2-binary
```

3. Валідація, налаштування та .env:

```
pip install pydantic
pydantic-settings
python-dotenv email-validator
```

4. Планувальник (Scheduler):

```
pip install apscheduler
```

5. Тести:

```
pip install pytest-env
```

Linux Mint

```
export TEST_DATABASE_URL='це пароль від нашої бази данних'
```

Windows

```
$env:TEST_DATABASE_URL = 'це пароль від нашої бази данних'
```

Важливо: smtplib та email.mime встановлювати не треба — вони вже вбудовані в Python.

## Запуск

Запустіть веб-сервер Uvicorn. Команда виконується з кореневої папки проекту:

```
uvicorn src.main:app --reload
```

Після успішного запуску відкрийте браузер та перейдіть за адресою: http://127.0.0.1:8000/docs

Запустити всі тести:

```
pytest
```

Запустити конкретний тестовий файл:

```

```

## Огляд структури проєкту

Проєкт реалізовано з використанням багатошарової архітектури (Layered Architecture). Це забезпечує "розділення відповідальності" (Separation of Concerns), де кожен модуль відповідає за свою вузьку задачу. Такий підхід робить код гнучким, легким для тестування та розширення.

#### Дерево каталогів:

```
src/
├── database.py                    # Підключення до БД
├── main.py                        # Точка входу, запуск Scheduler
├── models.py                      # Опис таблиць
├── scheduler.py                   # Налаштування фонових задач
├── schemas.py                     # Pydantic схеми (валідація)
├── .env                           # Паролі  почти та бази данних
├── routers/                       # Обробка HTTP запитів
│   ├── books.py
│   └── patrons.py
└── services/                      # Бізнес-логіка
    ├── book_service.py
    └── patron_service.py
    repositories/                  # Шар доступу до даних
    ├── ult_repository.py          # Базовий репозиторій для всіх репо , окрім нижче зазначенних
    └── relations_repository.py    # Базовий репозиторій класс для таблиць багто до батьох

```

#### Призначення основних модулів

src/routers/ (Router Layer): Цей шар приймає HTTP-запити від клієнта (GET, POST, PUT), проводить первинну валідацію даних через схеми Pydantic і передає управління сервісам. Роутери не містять бізнес-логіки, вони лише керують потоком даних.

`src/services/ :` Тут реалізовано бізнес-правила. Наприклад:

Чи можна видати книгу цьому користувачу? (перевірка боргів).
Розрахунок дати повернення.
Відправка email-сповіщень. Сервіси отримують дані від роутерів і звертаються до репозиторіїв за інформацією з БД.

`src/repositories/` (Data Access Layer): Відповідає виключно за спілкування з базою даних. Тут знаходяться SQL-запити (через методи SQLAlchemy: .add(), .query(), .commit()). Використання патерну "Generic Repository" дозволило уніфікувати стандартні операції (Create, Read, Update, Delete).

`src/models.py` та `src/schemas.py:`

**Models:** Класи, що відображають таблиці в базі даних (SQLAlchemy).

**Schemas (DTO):** Класи, що описують формат JSON, який приходить від клієнта або відправляється йому. Це гарантує, що API отримує тільки правильні типи даних.

## Приклади використання API:

**Сценарій 1**: Видача книги (Create Checkout)
Цей запит створює запис про видачу книги. Система автоматично перевіряє, чи активний читач і чи є вільні копії книги та чи нема у патрона боргів .

Метод: POST
URL: /checkout/

Тіло запиту (Request Body):

```JSON
{ "patron_id": 5, "book_id": 12, "end_time": 2025-12-31 }
```

Відповідь сервера (Response 200 OK):

```JSON

{"checkout_id": 104,

"patron_id": 5,

"book_copy_id": 3,

"start_time": "2025-12-17T14:30:00",

"end_time": "2025-12-31T14:30:00",

"status": "OK"}

```

**Сценарій 2:** Деактивація читача (Soft Delete)
Адміністратор деактивує користувача. Система перевіряє наявність боргів. Якщо боргів немає, статус змінюється на INACTIVE.

Метод: POST

URL: /patrons/5/soft_delete

Успішна відповідь (Response 200 OK):

```JSON
{
"detail": "Patron has been deactivated successfully. Account will be permanently deleted in 6 months."
}
```

## ER діаграма проєкту

потім вставлю

## Опис API Ендпоінтів

### Books

**POST /books/** - Додавання нової книги

**GET /books/** - Перегляд всіх книг

**PATCH /books/update** - Оновлення книги

**POST /books/batch** - Створення нової книги разом з кількістю авторами та жанрами

**POST /books/delete** - Видалення книги

### Patrons

**POST /patrons/** - Додавання нового патрону

**POST /patrons/soft_delete** - "М'яке" видалення патрона з системи , з шансом повернутися назад через 6 місяців , якщо ні видаляється патрон повністю

**POST/patrons/activate** - Відновлення аккаунта патрону після м'якого видалення

### Checkout

**PUT/checkout/renew** - Поновлення дедлайну здачі книгі

**POST/checkout/borrow** - Взяття книгі

**POST/checkout/return** - Повернення книгі

**POST/checkout/lost_book** - Звіт про втрату книгі + штраф

**GET/checkout/** - Показ свіх позик книг

### Waitlist

**POST/waitlist/** - Додавання черги на книгу

**POST/waitlist/issue** - Взяття книги з чергі очікування

**GET/waitlist/position** - Показ позиції в черзі

### Book-Copy

**POST/book-copy/update** - Зміна загальної кількості книг

**POST/book-copy/** - Додавання кількості книг

**GET/book-copy/** - Показ всіх наявних копій

### Author

**POST/author/** - Створення автора

### Genre

**POST/genre/** - Створення жанру

### Wishlist

**POST/wishlist/** - Створення бажаної книги

**GET/wishlist/** - Перегляд бажань

### Relations

**POST/relations/author-book** - Створення зв'язків між автор та книгой

**POST/relations/genre-book** - Створення зв'язків між жанром і книгой

### Notification

**GET/notification/{patron_id}** - СПерегляд сповіщенням у одного патрона

### Analytics (SQL)

**GET/analytics/top-patrons** - Перегляд топ-5 найактивніших користувачів

**GET/analytics/top-genre** - Перегляд топ 5 жанрів

## Історія змін коротко

### 11.12.2025

Почали документацію,запихнули міграції,зробили models.py.

### 12.12.2025

Початок роботи над бекендом, змогли додати book, patron та checkout через пайтон.

### 13.12.2025

Так... copy_book, waitlist є. Переробили репрезиторії тепер все зберігається в одному. Зробили checkout і зробили так, щоб у copy_book віднімалася кількість доступних примірників, і коли вона дорівнюватиме 0 можна вже створювати вейтліст.

### 14.12.2025

Додали Notification , зв'язок автор\жанр до книг, вішліст, зробили повернення книги (так, ми тільки зараз зрозуміли, що в нас не було цього ;-;)

### 15.12.2025

Додали комплексний сценарій створення сутності "Видача книги з черги очікування".

СПОВІЩЕННЯ НА ЕМЕЙЛ ПРИХОДЯТЬ ВИ ШО
<img width="789" height="272" alt="image" src="https://github.com/user-attachments/assets/d50f2788-2284-4517-9101-bb0ad1679f06" />

### 16.12.2025

Зробили сотий коміт

[Ми ніколи вас не підведемо](https://youtu.be/dQw4w9WgXcQ)
